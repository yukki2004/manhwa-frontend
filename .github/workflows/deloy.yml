name: Deploy TruyenVerse Frontend

on:
  push:
    branches: [ "master" ] 
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.vars.outputs.sha_short }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Short SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create .env file
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env
          echo "VITE_APP_NAME=${{ secrets.VITE_APP_NAME }}" >> .env
          echo "VITE_TIMEOUT=${{ secrets.VITE_TIMEOUT }}" >> .env
          echo "VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}" >> .env
          echo "VITE_APP_VERSION=${{ steps.vars.outputs.sha_short }}" >> .env

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/manhwa-frontend:${{ steps.vars.outputs.sha_short }}
            ${{ secrets.DOCKER_USERNAME }}/manhwa-frontend:latest

  deploy:
      needs: build-and-push
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Copy docker-compose.yml to server
          uses: appleboy/scp-action@v0.1.7
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ secrets.SSH_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            source: "docker-compose.yml"
            target: "/var/www/frontend-manhwa"
            strip_components: 0 

        - name: SSH and Deploy to VPS
          uses: appleboy/ssh-action@v1.0.3
          with:
            host: ${{ secrets.SSH_HOST }}
            username: ${{ secrets.SSH_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}
            envs: TAG=${{ needs.build-and-push.outputs.short_sha }}, DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            script: |
              cd /var/www/frontend-manhwa
              
              sudo DOCKER_USERNAME=$DOCKER_USERNAME TAG=$TAG docker compose pull frontend
              sudo DOCKER_USERNAME=$DOCKER_USERNAME TAG=$TAG docker compose up -d frontend
              
              sudo docker image rm $(sudo docker images -f "dangling=true" -f "reference=$DOCKER_USERNAME/manhwa-frontend" -q) || true
              echo "✅ Deploy thành công bản commit: $TAG"